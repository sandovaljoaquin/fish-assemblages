---
title: "Fish Assemblages"
format: html
editor: visual
author: Joaquin Sandoval 
date: 10/31/2025
---

```{r, output = FALSE}
library(tidyverse)
library(here)
library(janitor)
library(dplyr)
library(patchwork)
library(betareg)
```

```{r, output = FALSE}
# Read in data 
fish <- read_csv(here("data", "MCR_LTER_Annual_Fish_Survey_20250324.csv")) |> 
  janitor::clean_names()

coral_cover <- read_csv(here("data", "MCR_LTER_Coral_Cover_Backreef_Long_20250429.csv")) |> 
  janitor::clean_names()
```

```{r}
fish_through_years <- fish |> 
  group_by(year, fine_trophic) |> 
  summarise(n = n()) |> 
  mutate(total_number = n())


groups_through_years_plot <- ggplot(fish_through_years, 
       aes(x = year, 
           y = total_number, 
           color = fine_trophic)) + 
  geom_line() + 
  labs(y = "Total Number of Fish", 
       title = "Change in Backreef Fish Abundance (2006-2025)", 
       color = "Fish Type")
  
```

```{r, message = FALSE}
fish_2006 <- fish |> 
  group_by(fine_trophic, habitat) |> 
  filter(fine_trophic != "na")|> 
  filter(year == "2006") |> 
  filter(habitat == "Backreef") |> 
  summarise(n = n()) |> 
  mutate(total_number = n) |> 
  arrange(desc(total_number))
          
          
fish_2006_plot <- ggplot(fish_2006, aes(x = total_number, 
                      y = reorder(fine_trophic, +total_number), 
                      fill = fine_trophic)) +
  geom_col() + 
  ylab(" ") + 
  xlab("Count") + 
  labs(title = " 2006 Backreef Fish Abundance by Group", 
       x = "Count") +
  theme(legend.position = "none")

```

```{r,  message = FALSE}
fish_2024 <- fish |> 
  group_by(fine_trophic, habitat) |> 
  filter(fine_trophic != "na")|> 
  filter(year == "2024") |> 
  filter(habitat == "Backreef") |> 
  summarise(n = n()) |> 
  mutate(total_number = n) |> 
  arrange(desc(total_number))

fish_2024_plot <- ggplot(fish_2024, aes(x = total_number, 
                      y = reorder(fine_trophic, +total_number), 
                      fill = fine_trophic)) +
  geom_col() + 
  ylab(" ") + 
  xlab("Count") + 
  labs(title = " 2024 Backreef Fish Abundance by Group", 
       x = "Count") +
  theme(legend.position = "none")
```

```{r}
groups_through_years_plot

fish_2006_plot / fish_2024_plot
```

This above figures show how the abundance of each fish type (entire fish assemblage) changes through time in the backreef zone. For the first visualization, I thought a line plot would be more appropriate than a scatterplot. It is a bit busy so I may filter for less groups (i.e groups that feed or interact with coral/skeletons/macroalgae). The second figure is a combination of bar plots that show the abundance of each fish group in the first year of surveying (2006) and the last sampling year (2024).

```{r}

coral_cover <- coral_cover |> 
  filter(benthic_category == "coral") |> 
  group_by(year, site) |> 
  summarise(mean_site_coral_cover = mean(percent_cover)) 


```

```{r, message = FALSE}
# groupby both fish category and year, find total number of fish for that category 

corallivore <- fish |> 
  filter(habitat == "Backreef") |> 
  group_by(year, site ) |> 
  summarise(proportion_corallivore = mean(fine_trophic == "Corallivore", na.rm = TRUE)) 

```

```{r}
full_data_frame <- left_join(coral_cover, corallivore)

full_data_frame <- full_data_frame |> 
  mutate(site_number = (str_sub(site, 6))) |> 
  mutate(site_number = as.numeric(site_number))

ggplot(full_data_frame, 
       aes(x = mean_site_coral_cover, 
           y = proportion_corallivore, 
           color = year)) + 
  geom_point() + 
  facet_wrap("site")
```

```{r}
model <- betareg(
  proportion_corallivore ~ mean_site_coral_cover + site_number + year,
  data = full_data_frame,
  link = "logit"
)
summary(model)
```

```{r}
pred_grid <- expand_grid(mean_site_coral_cover = seq(0,1, by = 0.01)) |> 
  mutate(site_number = mean(full_data_frame$site_number, na.rm = TRUE), 
         year = mean(full_data_frame$year, na.rm = TRUE)) 

pred_grid <- pred_grid |> 
mutate(proportion_corallivore = predict(object = model, 
                            newdata = pred_grid, 
                            type = "response"))


betareg(proportion_corallivore ~ mean_site_coral_cover + site_number + year,
        data = pred_grid, 
        link = "logit")

```
